import { BigInt } from "./js/jscrypto/bigint.js";
import { ElGamal } from "./js/jscrypto/elgamal.js";
import { helios_c } from "./js/jscrypto/heliosc-trustee.js";
import Tally from "./js/jscrypto/tally.js";

let certificates, points, election, trustee_aux, tally, election_pk, pk, params;

const getSecretKey = (pk) => {
  helios_c.trustee = helios_c.trustee_create(params, pk);
  helios_c.params = params;
  helios_c.certificates = certificates;
  helios_c.points = points;
  // TODO: check key
  console.log(helios_c);
  var sk = helios_c.ui_share_get_direct();
  return new ElGamal.SecretKey(sk.x, sk.public_key);
};

const doTally = () => {
  if (!pk) {
    console.log("Clave incorrecta");
    return;
  }
  var secret_key = getSecretKey(pk);

  // ENCRYPTED TALLY :
  let tally_factors_and_proof = tally.map(function (q_tally) {
    return q_tally.doDecrypt(election_pk, secret_key);
  });

  let final_json = {
    decryptions: tally_factors_and_proof,
  };
  const decryptions = JSON.stringify(final_json);
  const blob = new Blob([decryptions], { type: "text/plain" });
  const a = document.createElement("a");
  a.style.display = "none";
  a.href = window.URL.createObjectURL(blob);
  a.download = "datos.json";
  document.body.appendChild(a);
  a.click();
  window.URL.revokeObjectURL(a.href);
  document.body.removeChild(a);
  document.getElementById("decryptions").innerHTML = decryptions;
};

const prepare = (election_params, data) => {
  certificates = data.certificates;
  points = data.points;
  election = data.election;
  trustee_aux = data.trustee;

  BigInt.setup(function () {
    params = ElGamal.Params.fromJSONObject(election_params);
    params.trustee_id = trustee_aux.trustee_id;
    election_pk = ElGamal.PublicKey.fromJSONObject(election["public_key"]);
    console.log(JSON.parse(election.encrypted_tally));
    tally = Tally.createAllTally(
      election.encrypted_tally,
      election_pk
    );
  });
};

const payload = {
  params: {
    p: "18327991482361669004286639798074385949400820527508693038281793842419658778646183172043714372434887662397495316046424276660244274945405969876809123683433321250545108479986526816070819839957965107425628145736191837131508884754895750146570877651437107861199128784596337922813704126294239514133764359696513958683035290336886031265046191900273191001058569366746816268635864575581741352326134814483409332935713546125268177796076176035462970215700537486727982100562697116663646391349282042978452419214916303106449995547276153571886404788957113873880035926652300634390083324146443946720486724627744466059746347363887763313743",
    q: "9163995741180834502143319899037192974700410263754346519140896921209829389323091586021857186217443831198747658023212138330122137472702984938404561841716660625272554239993263408035409919978982553712814072868095918565754442377447875073285438825718553930599564392298168961406852063147119757066882179848256979341517645168443015632523095950136595500529284683373408134317932287790870676163067407241704666467856773062634088898038088017731485107850268743363991050281348558331823195674641021489226209607458151553224997773638076785943202394478556936940017963326150317195041662073221973360243362313872233029873173681943881656871",
    g: "16141898911809788492463153022431594386168319330222751768493351040952735565361896626024447515650922389607562504530451845501876091151301288417170631825455184588835325157781438398677204184012389811003436159787883489522402724138691780356199397916889317025148963039437773815193899568773625897337438669015395689510555217519657274498167109193026516201153157184411632736242491162216511771478776845530382144041894008864963974005512677070493327538989029656740352284939727572199971495877462619563754716116212378070273900583647050080189064355617936261153568358447985978219381341970181603196085481796711486639560779759080607611174",
    l: "1",
    t: "0",
  },
  data: {
    election: {
      public_key: {
        y: "17336492314585176060425155083565087779515694896220188529209837425224493273419848111137845093844672606053358188904020620436572018012310164599236786081845778060440691674072778671327180656995460618357183678463031884716454648233842631817759416839007312995252233075742564574456174098500708749541727658927725177645180011609455206538581276265359518979117803215317405096206573105220830034365648394391311591872186342302996850794647570766471457390812997873452043355214824611310985052971957202024531548344686737781585500765797358300510723213514187020651452827534384161390123607239535165974823079316570848992067848638439162939294",
        p: "18327991482361669004286639798074385949400820527508693038281793842419658778646183172043714372434887662397495316046424276660244274945405969876809123683433321250545108479986526816070819839957965107425628145736191837131508884754895750146570877651437107861199128784596337922813704126294239514133764359696513958683035290336886031265046191900273191001058569366746816268635864575581741352326134814483409332935713546125268177796076176035462970215700537486727982100562697116663646391349282042978452419214916303106449995547276153571886404788957113873880035926652300634390083324146443946720486724627744466059746347363887763313743",
        g: "16141898911809788492463153022431594386168319330222751768493351040952735565361896626024447515650922389607562504530451845501876091151301288417170631825455184588835325157781438398677204184012389811003436159787883489522402724138691780356199397916889317025148963039437773815193899568773625897337438669015395689510555217519657274498167109193026516201153157184411632736242491162216511771478776845530382144041894008864963974005512677070493327538989029656740352284939727572199971495877462619563754716116212378070273900583647050080189064355617936261153568358447985978219381341970181603196085481796711486639560779759080607611174",
        q: "9163995741180834502143319899037192974700410263754346519140896921209829389323091586021857186217443831198747658023212138330122137472702984938404561841716660625272554239993263408035409919978982553712814072868095918565754442377447875073285438825718553930599564392298168961406852063147119757066882179848256979341517645168443015632523095950136595500529284683373408134317932287790870676163067407241704666467856773062634088898038088017731485107850268743363991050281348558331823195674641021489226209607458151553224997773638076785943202394478556936940017963326150317195041662073221973360243362313872233029873173681943881656871",
      },
      encrypted_tally: [
        {
          tally_type: "homomorphic",
          computed: "True",
          num_tallied: "1",
          q_num: "0",
          num_options: "4",
          tally: [
            {
              alpha:
                "14193345724711206796476942108348197227934655513698855676021691547371719237554253099505754709944142672107035973329131438329406159678436133610662220298371873995529866018538453383677198341642937947134282064392168793668448074045982144426133023891670741354896288543901915911742153098592427957908902687442028225611406802993882562596423659465693186311067727636353403146390458911260046524674944554452561567056505687916203031223751704517889165360392305687595412126320818655677595425426752427781590895512094947727470353458591909439088200914222071552791725558650608870363684210310568964006461295490182687353206079024443476928989",
              beta: "3339485053722766102016450950439678363708308125009953709666943284655296270562071586258624314975638241856755716769433807189483272904409797620478913917006581686221728461750795022617941306469542943956113577473773895761944774851765884828098062839864847841008934760485053574664273436322079165825014736124091887120217050543567910974111260975477745181852079442504033072483177558898475914822918569877337857203827859191529070331336368586523569703728462040968916370518209520490504267816294967868923274135572815783219088935230189248532415762817074033387929460468176846837853240193671550778888217733850596844447902401678294552422",
            },
            {
              alpha:
                "17880737138623647440108670901509306370697346897661143633953577430274599844004328689737123919828049681932196522981943066031680019192646028660558322960373064275490771723285736312920445419839346498340703789419703433979892006091555109700302012685587686246398505442748410835347912135279755674898554798679017536040678711887626412188105855126256037508564551303366219652801759040782064574416214909032374129855736561563917182931029601532174375956810869559862880470356748346573898611051977241503904661338842426568999676562637863414506067936811924621875510937955617491139056486555127102214308568896391519035632121532531487023654",
              beta: "3543880459448141147188340453323524046267259442189877943426352976461863333584475251262920209973014280294832460254059312721037997382773902196767637698039122406617951941199898381974750073269407908663577939683344312742160270047553541121079296445223192218866182854443557725094322578020333449361964568495284104367753205433672417492153761965631919964452067912041050701155866891059291923173650220864212400367985439323241822752324737236564846773048763951571498565557404365147362373641199648156331021624651738191340849478279216937239731918242272717882214968412142065875412169646797720298952107877584999245913669881248133556693",
            },
            {
              alpha:
                "13821429982740664920527984503838844297109999951570424251233800871172214500889171946911527470040238669744028182760463959091009015108657408059737040683278233034948988780527257554202725179273864623563819442850210852488124112338860250659379700035033075275494365951141460030280256368506662253772119700293210620239154214964005172031120399997207720977276854919926119959440251655281794436531621996603727467297614912342264140850978609073231082336260762814289013673878897014891343663969907676304729746328269629952298331129233776160872618084195191748036529812457397598064433534432742426290059704272651183780735323419888958502958",
              beta: "5657345391452081591347787914998260784202197285515535927661420447463341131982443425095496438416724313421952447764088850891525812436212885970197560006119274679459642953760647307926026165100707865643222888117943478851214813663221537321566420367859922144819467663738025043873784769766442853239524001695717317821681611122612860263326261563809494929851251202380889677179677071024222349364397878562433674059964030478650490888613026057409178208067181166104549928657905807559848925580935337583098820794150539214711674507453196139409739729731373215202414442463244104627668244699083653866727040767287035625168358774761670365452",
            },
            {
              alpha:
                "10185785998211289484150913550604514160514660570374875926961911098764857946003471676707582441485725667280777791631199514044622711445855479612754218894908457280137273308413367067041728367014610076241287530149367482636787362506493379117658775303577734101988972251895853989144116955126349786287010606562569538632365852010763472537614019164438865699257209738368762313415612698626721688307496480593414255290247404911284013441516746032258675745989233052588239083312429329978620127935579321476737823801529641090479994964444305699985491925065663991938248151916626474374101518901097996829579405468633211968881999682089176005297",
              beta: "4045438495635565978978325664265760788010117253356670821393493558229360378864527939020654192729719832239681270729383441644157488953151769850288491491993486642662820302874463048812039576253515848126454358277071428158864380252323305469786276406410552849118672207279284939522547898756225680101880261198284783960796800081435886619214468210771912134128440101930850813766708667250683487710889693736253190801691677622257586677383494276427540209216721147935720627794771313625004272288174906439522966133338373336777166837445017379075043900324074334787959320656973999219634029019158471376827905580453051883868308900841872497041",
            },
          ],
        },
      ],
    },
    trustee: {
      trustee_id: 1,
    },
    certificates: [
      {
        encryption_key:
          "11952576202581783599454817666007020482656713064978732166733301695014246432640548409297388303640818696941475921736043209228984013883181820135695207423569096518638253213116940526985319034559429579571631821389545337855041173507248144187879764526379521452344853430955907810306510901824519184933000462473587906475257187182691535887020957682442011792446670880087148177050079758862383761874895110944889818551180962365919843104855211752445392052611187584870005385414689287686549364315421056548248891368569203606184646764181462292588568912663956804456191093770200165189286074600822884603612155210409558593151975019081279529938",
        signature: {
          challenge:
            "114290444121147805573056397540209704530575966297414357831375702733311273126284",
          response:
            "223361700133131868166437318026050399530328518163261475851860784867053267623908353738996604254772333498968869296470104060647758033469344046072673039283177215729716566369819309541742222403960659374547527826890938444544392150942698219952360928224488550515101196877729366744797279968697819752602303258499683441010521169859573494248424001816491319885600507989512518071880302580891110723606945413364525778281862150465008985454449152340411283342692077127085237500392698365502856136769675885467111986357087136526297066759950508077380677221234659845297419922720116377672651887397402587048032192402200248031194697533720620715",
        },
        signature_key:
          "8270703994334735671727969892691369104569418170095493640340698628149810658120156042520881945081839759947214906453496476990744225958971619401001038633341927783602198921553853879997397848033436981635504337652431928392247032801278118963209425890573530682005264227478195912702311994006312550918885209306952995683595095243404210758899944339309502575853038059269255172466576521504670505826331050130375674631894635117537574828455070626469486738872833107877064921824786533040230886364871785377522754019044388135928290444972929150845218228768919212121844644484672153767915079301282129213740363066233134040442533913240934644269",
      },
    ],
    points: [
      {
        alpha:
          "10201123471725177289350090935759667529849312001738639091206486809157547624571802692342360051205718371130212868437888410340422077900056028012754689901334707631991035655660046123687454290202263204339350398049718005414239570102799924618040506475238196606676242550032138633355800485040961446927456274567306820909467475711396646873197840611544552419576817743263030493711557939950238159669180505392526387405220934165456170272276905564469685610211546416541727274772087706256303382488302554374241612038015402916427052956530597357620644308629895011566255962248536603389400746937069113931695525914582371432603818011421081260971",
        beta: "54008d873b60ced0127c87309fb86ebe1c3c86ff933b212a569e8472a08ee3bee62905d499a550096ea3593cf22fd476e89b0900fec52afd3ac452fe121d2544f79802af36bd9b0e9dfe97d8a6c7de48919af13dc0",
        signature: {
          challenge:
            "17375360517156834944143835005420572120614810082436996925361487949460426051096",
          response:
            "2969153179125162982878166782165425362961553966076556026814432848117784864918702836542221456603889330116024328975503314747664790621455975638408429249827296288009949555377624585820135834837110996036266033073123983365854910790191441082326983421091529288915783428719046742939097839614354117839620523113858511774166024481403146463160163055227569799062436196206540183322166867265690155176781204059069420545655961716622193175819196110625096322282677257954033925146974328522322479386191384559619774830597459210415812444826999738556521722025936444813806216373531194279056597971028234612798874006841896207154180218025672823058",
        },
      },
    ],
  },
};

pk = "3266d16288239213b119ef6a4e9e630feb3d2fb208fc4242eedf24454d3aed56";
prepare(payload.params, payload.data);
doTally();
